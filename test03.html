<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>タイピングゲーム (ひらがな・ローマ字版)</title>
    <style>
        /* 既存のCSS */
        body { font-family: sans-serif; text-align: center; margin: 20px; }
        #question { font-size: 2em; font-weight: bold; margin: 10px; }
        #romaji { font-size: 1.2em; color: #555; margin-bottom: 20px; }
        #answer { 
            font-size: 1.5em; 
            padding: 10px; 
            width: 300px; 
            ime-mode: disabled; 
            margin-bottom: 20px; /* キーボードとの間隔 */
        }
        #message { height: 1.5em; color: green; }

        /* --- キーボードのCSSここから --- */
        #keyboard {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 30px;
            user-select: none; /* キーが選択されないように */
        }

        .keyboard-row {
            display: flex;
            margin-bottom: 5px; /* 行間のスペース */
        }

        .key {
            width: 40px; /* 標準キーの幅 */
            height: 40px; /* 標準キーの高さ */
            border: 1px solid #ccc;
            border-radius: 5px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 2px; /* キー同士のスペース */
            background-color: #f9f9f9;
            box-shadow: 0 2px 0 #ddd;
            font-size: 0.9em;
            font-weight: bold;
            text-transform: uppercase; /* 文字を大文字に */
            position: relative;
            transition: background-color 0.1s; /* ハイライトのアニメーション */
        }

        /* 特殊キーの幅 */
        .key.tab, .key.caps, .key.shift, .key.enter, .key.backspace {
            width: 60px; 
        }
        .key.ctrl, .key.alt, .key.cmd {
             width: 50px;
        }
        .key.space {
            width: 300px; /* スペースキー */
        }
        .key.backspace { background-color: #f0f0f0; }
        .key.tab { background-color: #f0f0f0; }
        .key.caps { background-color: #f0f0f0; }
        .key.enter { background-color: #f0f0f0; }
        .key.shift { background-color: #f0f0f0; }
        .key.ctrl { background-color: #f0f0f0; }
        .key.alt { background-color: #f0f0f0; }
        .key.cmd { background-color: #f0f0f0; }

        /* キーが押されたときの視覚的フィードバック */
        .key.pressed {
            background-color: #e0e0e0;
            box-shadow: 0 1px 0 #bbb;
            transform: translateY(1px);
        }

        /* ハイライトのスタイル */
        .key.highlight {
            background-color: #ffeb3b; /* 黄色 */
            border-color: #ffc107;
            box-shadow: 0 2px 0 #ffc107;
        }
        /* --- キーボードのCSSここまで --- */
    </style>
</head>
<body>

    <h1>タイピングゲーム</h1>
    <div id="question">読み込み中...</div>
    <div id="romaji"></div> <input type="text" id="answer" autocomplete="off" autocorrect="off">
    <div id="message"></div>

    <div id="keyboard">
        <div class="keyboard-row">
            <div class="key" data-char="~" data-key="`">`</div>
            <div class="key" data-char="1" data-key="1">1</div>
            <div class="key" data-char="2" data-key="2">2</div>
            <div class="key" data-char="3" data-key="3">3</div>
            <div class="key" data-char="4" data-key="4">4</div>
            <div class="key" data-char="5" data-key="5">5</div>
            <div class="key" data-char="6" data-key="6">6</div>
            <div class="key" data-char="7" data-key="7">7</div>
            <div class="key" data-char="8" data-key="8">8</div>
            <div class="key" data-char="9" data-key="9">9</div>
            <div class="key" data-char="0" data-key="0">0</div>
            <div class="key" data-char="-" data-key="-">-</div>
            <div class="key" data-char="=" data-key="=">=</div>
            <div class="key backspace" data-char="backspace" data-key="backspace">Backspace</div>
        </div>
        <div class="keyboard-row">
            <div class="key tab" data-char="tab" data-key="tab">Tab</div>
            <div class="key" data-char="q" data-key="q">Q</div>
            <div class="key" data-char="w" data-key="w">W</div>
            <div class="key" data-char="e" data-key="e">E</div>
            <div class="key" data-char="r" data-key="r">R</div>
            <div class="key" data-char="t" data-key="t">T</div>
            <div class="key" data-char="y" data-key="y">Y</div>
            <div class="key" data-char="u" data-key="u">U</div>
            <div class="key" data-char="i" data-key="i">I</div>
            <div class="key" data-char="o" data-key="o">O</div>
            <div class="key" data-char="p" data-key="p">P</div>
            <div class="key" data-char="[" data-key="[">[</div>
            <div class="key" data-char="]" data-key="]">]</div>
            <div class="key" data-char="\" data-key="\">${'\\'}</div>
        </div>
        <div class="keyboard-row">
            <div class="key caps" data-char="capslock" data-key="capslock">Caps Lock</div>
            <div class="key" data-char="a" data-key="a">A</div>
            <div class="key" data-char="s" data-key="s">S</div>
            <div class="key" data-char="d" data-key="d">D</div>
            <div class="key" data-char="f" data-key="f">F</div>
            <div class="key" data-char="g" data-key="g">G</div>
            <div class="key" data-char="h" data-key="h">H</div>
            <div class="key" data-char="j" data-key="j">J</div>
            <div class="key" data-char="k" data-key="k">K</div>
            <div class="key" data-char="l" data-key="l">L</div>
            <div class="key" data-char=";" data-key=";">;</div>
            <div class="key" data-char="'" data-key="'">'</div>
            <div class="key enter" data-char="enter" data-key="enter">Enter</div>
        </div>
        <div class="keyboard-row">
            <div class="key shift" data-char="shift" data-key="shiftleft">Shift</div>
            <div class="key" data-char="z" data-key="z">Z</div>
            <div class="key" data-char="x" data-key="x">X</div>
            <div class="key" data-char="c" data-key="c">C</div>
            <div class="key" data-char="v" data-key="v">V</div>
            <div class="key" data-char="b" data-key="b">B</div>
            <div class="key" data-char="n" data-key="n">N</div>
            <div class="key" data-char="m" data-key="m">M</div>
            <div class="key" data-char="," data-key=",">,</div>
            <div class="key" data-char="." data-key=".">.</div>
            <div class="key" data-char="/" data-key="/">/</div>
            <div class="key shift" data-char="shift" data-key="shiftright">Shift</div>
        </div>
        <div class="keyboard-row">
            <div class="key ctrl" data-char="ctrl" data-key="controlleft">Ctrl</div>
            <div class="key alt" data-char="alt" data-key="altleft">Alt</div>
            <div class="key space" data-char=" " data-key=" ">Space</div>
            <div class="key alt" data-char="alt" data-key="altright">Alt</div>
            <div class="key ctrl" data-char="ctrl" data-key="controlright">Ctrl</div>
        </div>
    </div>

    <script>
        // ▼▼▼ ステップ1で取得した「新しい」CSVの公開URLを貼り付け ▼▼▼
        const DATA_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR-BFItFVtJWMXf0GdsdB3Ln7Hz5qvcjDVSyBU0T6MosUelNmO0_oVt9pWg9ekdyAtqaBDokkVWKolj/pub?gid=543569375&single=true&output=csv';

        // words配列。例: [{q: 'こんにちは', r: 'konnitiwa'}, {q: 'ありがとう', r: 'arigatou'}]
        let words = [];
        let currentWord = null; // 現在のお題オブジェクト

        const questionEl = document.getElementById("question");
        const romajiEl = document.getElementById("romaji"); // ローマ字表示用
        const answerEl = document.getElementById("answer");
        const messageEl = document.getElementById("message");

        // データを読み込む
        async function loadWords() {
            try {
                const response = await fetch(DATA_URL);
                if (!response.ok) {
                    throw new Error('データの取得に失敗しました。');
                }
                
                const csvText = await response.text();
                
                // --- CSVをオブジェクト配列に変換 (修正箇所) ---
                words = csvText.split(/\r?\n/) // 1. 行で区切る
                             .filter(Boolean)      // 2. 空行を除去
                             .map(row => {         // 3. 各行を処理
                                const parts = row.split(','); // 4. カンマで区切る
                                if (parts.length >= 2) {
                                    return { 
                                        q: parts[0].trim(), // A列 (ひらがな)
                                        r: parts[1].trim()  // B列 (ローマ字)
                                    };
                                }
                                return null; // データ不備の行はnull
                             })
                             .filter(Boolean); // nullになった行を除去

                if (words.length === 0) {
                    throw new Error('単語リストが空か、形式が正しくありません。');
                }

                console.log("読み込んだ単語オブジェクト:", words);
                setNextWord();
                
            } catch (error) {
                console.error("エラー:", error);
                questionEl.textContent = error.message;
            }
        }

        // 次の問題をセット
        function setNextWord() {
            if (words.length === 0) {
                questionEl.textContent = "ゲームクリア！";
                romajiEl.textContent = "おめでとうございます！";
                answerEl.disabled = true; // 入力不可にする
                return;
            }

            const index = Math.floor(Math.random() * words.length);
            currentWord = words[index]; // 例: {q: 'こんにちは', r: 'konnitiwa'}

            // 画面にセット (修正箇所)
            questionEl.textContent = currentWord.q; // お題(ひらがな)
            romajiEl.textContent = currentWord.r;   // ローマ字 (ヒントとして表示)
            
            answerEl.value = ''; // 入力欄をクリア
            answerEl.focus(); 
            messageEl.textContent = '';
        }

        // 入力をチェック
        answerEl.addEventListener('input', (e) => {
            if (!currentWord) return; // お題がセットされる前は無視

            const inputText = e.target.value;
            
            // 正解判定 (修正箇所)
            if (inputText === currentWord.r) {
                // 正解！
                messageEl.textContent = 'OK!';
                setTimeout(setNextWord, 300); 
            
            // 入力途中かどうかの判定 (修正箇所)
            } else if (currentWord.r.startsWith(inputText)) {
                // 入力途中
                messageEl.textContent = '';
            } else {
                // タイプミス
                messageEl.textContent = 'ミス！';
            }
        });

        // ゲーム開始
        loadWords();
    </script>
</body>
</html>